# ü§ñ Bot XML GMS - Worker# Bot-XML-GMS



Worker para automa√ß√£o de download e processamento de documentos fiscais eletr√¥nicos (NF-e/NFC-e) do portal GMS, controlado pelo **RPS Maestro** via RabbitMQ.`bot-xml-gms` √© um projeto de automa√ß√£o projetado para extrair arquivos XML de documentos fiscais (NF-e, NFC-e) do sistema web cont√°bil do Grupo Maria Selma (GMS) ```https://cp10307.retaguarda.grupoboticario.com.br/```. A solu√ß√£o √© encapsulada em uma API moderna e escal√°vel para facilitar a execu√ß√£o, o monitoramento e a integra√ß√£o com outros sistemas.



## üìã Descri√ß√£o## ‚ú® Funcionalidades



Este bot √© um **worker "burro"** que:  * **API de Controle Robusta**: Uma API RESTful (criada com FastAPI) para enfileirar, monitorar, cancelar e obter logs das tarefas de automa√ß√£o.

- ‚úÖ Escuta mensagens em uma fila RabbitMQ  * **Execu√ß√£o Ass√≠ncrona e Escal√°vel**: As automa√ß√µes rodam como tarefas em background com Celery e Redis, permitindo que a API responda imediatamente e que m√∫ltiplos workers possam processar tarefas em paralelo.

- ‚úÖ Executa tarefas de download conforme instru√ß√µes recebidas  * **Padr√£o Page Object Model (POM)**: A intera√ß√£o com o site √© modular, reutiliz√°vel e f√°cil de manter, desacoplando a l√≥gica de automa√ß√£o da estrutura das p√°ginas web.

- ‚úÖ Reporta status de execu√ß√£o via HTTP para o Maestro  * **Configura√ß√£o Externalizada**: Credenciais, URLs e seletores de elementos s√£o gerenciados fora do c√≥digo-fonte (`.env`, `.yaml`), permitindo f√°cil adapta√ß√£o a diferentes ambientes sem alterar o c√≥digo.

- ‚úÖ Processa e organiza arquivos XML baixados  * **Containeriza√ß√£o Completa**: O ambiente inteiro (API, Worker, Redis) √© gerenciado com Docker e Docker Compose, garantindo consist√™ncia e facilitando o deploy.

  * **Logging Detalhado por Tarefa**: Logs completos s√£o gerados com um `task_id` associado, permitindo rastrear a execu√ß√£o de cada requisi√ß√£o de forma isolada.

## üèóÔ∏è Arquitetura  * **Processamento Inteligente de Arquivos**: O rob√¥ lida com o download, descompacta√ß√£o de arquivos ZIP aninhados e organiza√ß√£o dos XMLs em uma estrutura de pastas l√≥gica (`ano/m√™s/per√≠odo`).

  * **Resumo da Execu√ß√£o**: Ao final do processo, um resumo em JSON √© gerado com estat√≠sticas detalhadas sobre os documentos extra√≠dos.

```

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê## üèóÔ∏è Arquitetura

‚îÇ  RPS Maestro    ‚îÇ (Sistema principal em Go)

‚îÇ   (Go API)      ‚îÇO sistema √© arquitetado em um modelo de microservi√ßos desacoplado, ideal para tarefas de longa dura√ß√£o:

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         ‚îÇ1.  **API (`api`)**: O ponto de entrada do sistema. Uma aplica√ß√£o FastAPI que recebe as requisi√ß√µes, valida os par√¢metros e enfileira a tarefa de automa√ß√£o.

         ‚îÇ HTTP Status Reports2.  **Broker (`redis`)**: Um servidor Redis que atua como intermedi√°rio (message broker), gerenciando a fila de tarefas a serem processadas.

         ‚ñº3.  **Worker (`worker`)**: Um processo Celery que consome as tarefas da fila do Redis e as executa. √â o worker que efetivamente instancia o rob√¥ Selenium para realizar a automa√ß√£o no navegador.

    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

    ‚îÇ Worker ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ RabbitMQ MessagesO fluxo de execu√ß√£o √© o seguinte:

    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`Cliente -> POST /execute -> API (FastAPI) -> Enfileira Tarefa (Redis) -> Worker (Celery) -> Rob√¥ Selenium -> Interage com Sistema GMS -> Processa Arquivos -> Salva Resultado`

         ‚îÇ

         ‚ñº## ‚öôÔ∏è Pr√©-requisitos

    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê

    ‚îÇ  GMS   ‚îÇ (Portal Web)  * **Docker** e **Docker Compose**.

    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  * Acesso e credenciais para o sistema GMS.

```

## üöÄ Instala√ß√£o e Configura√ß√£o

## üöÄ In√≠cio R√°pido

1.  **Clone o reposit√≥rio:**

### Pr√©-requisitos

    ```bash

- Docker & Docker Compose    git clone https://github.com/EnzzoHosaki/bot-xml-gms.git

- Acesso ao RPS Maestro    cd bot-xml-gms

- Credenciais do portal GMS    ```



### Configura√ß√£o2.  **Configure as vari√°veis de ambiente:**

    Crie um arquivo chamado `.env` na raiz do projeto. Voc√™ pode copiar o conte√∫do abaixo como ponto de partida.

1. **Clone o reposit√≥rio**

```bash    **Arquivo `.env`:**

git clone <repository-url>

cd bot-xml-gms    ```ini

```    GMS_USER="seu_usuario"

    GMS_PASSWORD="sua_senha"

2. **Configure as vari√°veis de ambiente**    ```



Edite o arquivo `.env`:    *Observa√ß√£o: As credenciais tamb√©m podem ser enviadas diretamente no corpo da requisi√ß√£o da API, o que sobrescrever√° os valores do `.env`.*



```bash3.  **Configure os Seletores:**

# Identifica√ß√£o do Worker    Se a interface do sistema GMS for customizada, ajuste os seletores CSS ou XPath no arquivo `config/selectors.yaml` para corresponder aos elementos da sua interface.

WORKER_ID=worker-gms-01

## ‚ñ∂Ô∏è Como Usar

# Credenciais GMS

GMS_USER="seu_usuario"### 1\. Iniciar a Aplica√ß√£o com Docker

GMS_PASSWORD="sua_senha"

Com o Docker em execu√ß√£o, inicie todos os servi√ßos (API, Worker e Redis) com um √∫nico comando:

# RabbitMQ (apontar para o Maestro)

RABBITMQ_HOST=maestro-rabbitmq-host```bash

RABBITMQ_PORT=5672docker-compose up --build

RABBITMQ_USER=admin```

RABBITMQ_PASSWORD=admin123

RABBITMQ_QUEUE=bot-xml-tasksO servidor da API estar√° dispon√≠vel em `http://localhost:8000`.



# Maestro API### 2\. Acessar a Documenta√ß√£o da API

MAESTRO_API_URL=http://maestro-host:8080

Acesse **[http://localhost:8000/docs](https://www.google.com/search?q=http://localhost:8000/docs)** no seu navegador para ver a documenta√ß√£o interativa da API (Swagger UI), onde voc√™ pode testar os endpoints diretamente.

# Logging

LOG_LEVEL=INFO### 3\. Enfileirar uma Nova Extra√ß√£o

```

Envie uma requisi√ß√£o `POST` para o endpoint `/execute` com os par√¢metros da automa√ß√£o no corpo da requisi√ß√£o.

3. **Inicie o worker**

**Exemplo usando `curl`:**

```bash

# Desenvolvimento (com RabbitMQ local)```bash

docker-compose up -dcurl -X POST "http://localhost:8000/execute" -H "Content-Type: application/json" -d \

'{

# Produ√ß√£o (conecta ao RabbitMQ do Maestro)  "headless": true,

docker-compose up -d worker  "stores": [101, 550, 105],

```  "document_type": "NFE",

  "emitter": "PROPRIO",

## üì® Formato de Mensagens  "operation_type": "TODAS",

  "file_type": "XML",

O worker espera mensagens JSON na fila RabbitMQ com o seguinte formato:  "invoice_situation": "TODAS",

  "start_date": "01/10/2025",

```json  "end_date": "01/10/2025",

{  "gms_login_url": "https://cp10307.retaguarda.grupoboticario.com.br/app/#/login",

  "task_id": "uuid-da-tarefa",  "gms_user": "usuario_opcional_api",

  "stores": ["LOJA001", "LOJA002"],  "gms_password": "senha_opcional_api"

  "document_type": "NFE",}'

  "emitter": "Qualquer",```

  "operation_type": "Qualquer",

  "file_type": "XML",A resposta ser√° um JSON com o `task_id` da execu√ß√£o, que voc√™ usar√° para monitor√°-la:

  "invoice_situation": "Qualquer",

  "start_date": "01/01/2024",```json

  "end_date": "31/01/2024",{

  "gms_user": "usuario_opcional",  "task_id": "a1b2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6",

  "gms_password": "senha_opcional",  "message": "Automa√ß√£o enfileirada para execu√ß√£o."

  "gms_login_url": "https://portal.gms.com.br/login",}

  "headless": true```

}

```### 4\. Verificar o Status da Tarefa



### Campos Obrigat√≥riosUse os endpoints de status para acompanhar o progresso. Substitua `{task_id}` pelo ID retornado no passo anterior.



- `task_id`: ID √∫nico da tarefa  * **Verificar o status geral:**

- `stores`: Array com c√≥digos das lojas

- `document_type`: Tipo do documento (`NFE` ou `NFCE`)    ```bash

- `start_date`: Data inicial (DD/MM/YYYY)    curl -X GET "http://localhost:8000/status/a1b2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6"

- `end_date`: Data final (DD/MM/YYYY)    ```

- `gms_login_url`: URL de login do portal GMS

    A resposta mostrar√° o status (`PENDING`, `PROGRESS`, `SUCCESS`, `FAILURE`), informa√ß√µes sobre o progresso e o resumo final quando a execu√ß√£o terminar.

### Campos Opcionais

  * **Ver os logs completos:**

- `gms_user`: Usu√°rio GMS (usa `.env` se n√£o informado)

- `gms_password`: Senha GMS (usa `.env` se n√£o informado)    ```bash

- `emitter`: Filtro de emitente (padr√£o: "Qualquer")    curl -X GET "http://localhost:8000/logs/a1b2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6"

- `operation_type`: Tipo de opera√ß√£o (padr√£o: "Qualquer")    ```

- `file_type`: Tipo de arquivo (padr√£o: "XML")

- `invoice_situation`: Situa√ß√£o da nota (padr√£o: "Qualquer")  * **Acompanhar logs em tempo real (streaming):**

- `headless`: Executar em modo headless (padr√£o: true)

    ```bash

## üìä Reportes de Status    curl -X GET "http://localhost:8000/logs/a1b2c3d4-e5f6-a7b8-c9d0-e1f2a3b4c5d6/stream"

    ```

O worker reporta status para o Maestro via HTTP POST em `/api/tasks/{task_id}/status`:

## üìÇ Estrutura do Projeto

### Status: `started`

```json```

{.

  "task_id": "uuid",‚îú‚îÄ‚îÄ api.py                  # Servidor da API (FastAPI)

  "status": "started",‚îú‚îÄ‚îÄ tasks.py                # Defini√ß√£o das tarefas do Celery

  "timestamp": 1234567890,‚îú‚îÄ‚îÄ main.py                 # Ponto de entrada para execu√ß√£o via linha de comando (CLI)

  "worker_id": "worker-gms-01",‚îú‚îÄ‚îÄ Dockerfile              # Instru√ß√µes para construir a imagem da aplica√ß√£o

  "data": {‚îú‚îÄ‚îÄ docker-compose.yml      # Orquestra√ß√£o dos servi√ßos para desenvolvimento

    "document_type": "NFE",‚îú‚îÄ‚îÄ docker-compose.prod.yml # Orquestra√ß√£o dos servi√ßos para produ√ß√£o

    "start_date": "01/01/2024",‚îú‚îÄ‚îÄ requirements.txt        # Depend√™ncias do projeto

    "end_date": "31/01/2024",‚îú‚îÄ‚îÄ .env                    # Arquivo de vari√°veis de ambiente (local)

    "stores": ["LOJA001"]‚îú‚îÄ‚îÄ config/

  }‚îÇ   ‚îú‚îÄ‚îÄ settings.py         # Configura√ß√µes centrais e cria√ß√£o de pastas

}‚îÇ   ‚îî‚îÄ‚îÄ selectors.yaml      # Seletores de elementos da interface

```‚îú‚îÄ‚îÄ downloads/

‚îÇ   ‚îú‚îÄ‚îÄ pending/            # Pasta tempor√°ria para arquivos baixados

### Status: `completed`‚îÇ   ‚îî‚îÄ‚îÄ processed/          # Destino final dos arquivos XML organizados

```json‚îú‚îÄ‚îÄ logs/                   # Arquivos de log da execu√ß√£o

{‚îî‚îÄ‚îÄ src/

  "task_id": "uuid",    ‚îú‚îÄ‚îÄ automation/

  "status": "completed",    ‚îÇ   ‚îú‚îÄ‚îÄ browser_handler.py  # Gerencia a inicializa√ß√£o e configura√ß√£o do Selenium

  "timestamp": 1234567890,    ‚îÇ   ‚îî‚îÄ‚îÄ page_objects/   # Classes do Padr√£o Page Object Model

  "worker_id": "worker-gms-01",    ‚îú‚îÄ‚îÄ core/

  "data": {    ‚îÇ   ‚îî‚îÄ‚îÄ bot_runner.py   # Orquestra o fluxo da automa√ß√£o

    "status": "completed",    ‚îî‚îÄ‚îÄ utils/

    "duration_seconds": 123.45,        ‚îú‚îÄ‚îÄ data_handler.py     # Fun√ß√µes para ler arquivos de dados (JSON, YAML)

    "summary": {        ‚îú‚îÄ‚îÄ exceptions.py       # Exce√ß√µes customizadas da aplica√ß√£o

      "total_xml_files_analyzed": 100,        ‚îú‚îÄ‚îÄ file_handler.py     # L√≥gica de processamento dos arquivos baixados

      "valid_invoices_found": 95        ‚îî‚îÄ‚îÄ logger_config.py    # Configura√ß√£o do sistema de logging

    }```
  }
}
```

### Status: `failed`
```json
{
  "task_id": "uuid",
  "status": "failed",
  "timestamp": 1234567890,
  "worker_id": "worker-gms-01",
  "data": {
    "status": "failed",
    "error": "Mensagem de erro",
    "error_type": "AutomationException"
  }
}
```

## üìÇ Estrutura de Diret√≥rios

```
bot-xml-gms/
‚îú‚îÄ‚îÄ worker.py              # Ponto de entrada do worker
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ settings.py        # Configura√ß√µes (Pydantic)
‚îÇ   ‚îî‚îÄ‚îÄ selectors.yaml     # Seletores CSS/XPath
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ bot_runner.py  # L√≥gica principal da automa√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ automation/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ browser_handler.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page_objects/  # Page Objects para Selenium
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ file_handler.py
‚îÇ       ‚îú‚îÄ‚îÄ data_handler.py
‚îÇ       ‚îî‚îÄ‚îÄ exceptions.py
‚îú‚îÄ‚îÄ downloads/
‚îÇ   ‚îú‚îÄ‚îÄ pending/           # Arquivos tempor√°rios
‚îÇ   ‚îî‚îÄ‚îÄ processed/         # Arquivos organizados
‚îî‚îÄ‚îÄ logs/                  # Logs de execu√ß√£o
```

## üê≥ Docker

### Build da Imagem

```bash
docker build -t bot-xml-gms:latest .
```

### Vari√°veis de Ambiente

Todas as configura√ß√µes podem ser passadas via vari√°veis de ambiente:

```bash
docker run -d \
  -e WORKER_ID=worker-01 \
  -e RABBITMQ_HOST=rabbitmq \
  -e MAESTRO_API_URL=http://maestro:8080 \
  -e GMS_USER=usuario \
  -e GMS_PASSWORD=senha \
  -v $(pwd)/downloads:/app/downloads \
  -v $(pwd)/logs:/app/logs \
  bot-xml-gms:latest
```

## üìù Logs

Os logs s√£o salvos em:
- Console (stdout): Todos os n√≠veis configurados
- Arquivo: `logs/bot.log` (rotacionado automaticamente)

N√≠veis de log:
- `DEBUG`: Detalhes completos da execu√ß√£o
- `INFO`: Informa√ß√µes gerais (padr√£o)
- `WARNING`: Avisos
- `ERROR`: Erros recuper√°veis
- `CRITICAL`: Erros fatais

## üîß Desenvolvimento

### Executar Localmente

```bash
# Criar ambiente virtual
python -m venv venv
source venv/bin/activate  # Linux/Mac
.\venv\Scripts\activate   # Windows

# Instalar depend√™ncias
pip install -r requirements.txt

# Executar worker
python worker.py
```

## üõ†Ô∏è Tecnologias

- **Python 3.9+**: Linguagem principal
- **Selenium**: Automa√ß√£o web
- **Pika**: Cliente RabbitMQ
- **Requests**: Cliente HTTP
- **Pydantic**: Valida√ß√£o de configura√ß√µes
- **Docker**: Containeriza√ß√£o

## üìä Monitoramento

### RabbitMQ Management UI

Acesse `http://localhost:15672` para monitorar:
- Mensagens na fila
- Conex√µes ativas
- Taxa de consumo

**Credenciais:** admin/admin123

### Logs do Worker

```bash
# Ver logs em tempo real
docker-compose logs -f worker

# √öltimas 100 linhas
docker-compose logs --tail=100 worker
```

## üîí Seguran√ßa

- ‚ö†Ô∏è **Nunca commite** o arquivo `.env` com credenciais reais
- ‚úÖ Use secrets management em produ√ß√£o (Docker Secrets, Vault, etc.)
- ‚úÖ Rode o worker em rede privada isolada
- ‚úÖ Use TLS para comunica√ß√£o com RabbitMQ e Maestro

## ü§ù Integra√ß√£o com RPS Maestro

O RPS Maestro (sistema em Go) √© respons√°vel por:
- üìã Gerenciar a fila de tarefas
- üìä Coordenar m√∫ltiplos workers
- üìà Agregar estat√≠sticas
- üîî Notificar usu√°rios
- üíæ Persistir resultados

Este worker √© um **componente passivo** que apenas:
- üëÇ Escuta comandos
- ‚öôÔ∏è Executa tarefas
- üì£ Reporta status

## üìû Troubleshooting

### Worker n√£o conecta ao RabbitMQ

```bash
# Verificar conectividade
docker exec bot-xml-worker ping rabbitmq

# Verificar logs
docker-compose logs rabbitmq
```

### Timeout no download

Ajuste os timeouts no `.env`:
```bash
DOWNLOAD_TIMEOUT=600  # 10 minutos
PAGE_LOAD_TIMEOUT=60
```

### Erro de credenciais GMS

Verifique no `.env`:
```bash
GMS_USER="usuario_correto"
GMS_PASSWORD="senha_correta"
```

## üìÑ Licen√ßa

Propriet√°rio - RPS

## üë• Autores

RPS - Robotic Process Solutions

---

**Nota:** Este √© um worker controlado pelo RPS Maestro. Para informa√ß√µes sobre a API principal, consulte a documenta√ß√£o do Maestro.
